<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>營北國中載具借用系統</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --primary-color: #0d6efd;
      --secondary-color: #e9ecef;
    }
    
    body {
      font-family: '微軟正黑體', sans-serif;
      background-color: var(--secondary-color);
    }
    
    .navbar {
      background-color: var(--primary-color) !important;
    }
    
    .container {
      max-width: 1200px;
      margin: 20px auto;
    }
    
    .table th {
      background-color: var(--primary-color);
      color: white;
    }
    
    .schedule-cell {
      min-width: 150px;
    }

    .not-available {
      background-color: #dbd5d5 !important;
    }

    .permanent-blocked {
      background-color: #c9b3b3 !important;
    }

    .reserved {
      background-color: #f2ecb6 !important;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">營北國中載具借用系統</a>
      <div>
        <button id="loginBtn" class="btn btn-light">管理者登入</button>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="row mb-3">
      <div class="col">
        <select id="roomSelect" class="form-select">
          <option value="ipad">iPad教室</option>
          <option value="chromebook">Chromebook教室</option>
          <option value="chromebook-backup">備用Chromebook教室</option>
        </select>
      </div>
      <div class="col">
        <select id="weekSelect" class="form-select">
        </select>
      </div>
      <div class="col">
        <button id="prevWeek" class="btn btn-primary">上一週</button>
        <button id="nextWeek" class="btn btn-primary">下一週</button>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>節次</th>
            <th>週一</th>
            <th>週二</th>
            <th>週三</th>
            <th>週四</th>
            <th>週五</th>
          </tr>
        </thead>
        <tbody id="scheduleBody">
        </tbody>
      </table>
    </div>
  </div>

  <!-- Login Modal -->
  <div class="modal fade" id="loginModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">管理者登入</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="loginForm">
            <div class="mb-3">
              <label class="form-label">帳號</label>
              <input type="text" class="form-control" id="username" required>
            </div>
            <div class="mb-3">
              <label class="form-label">密碼</label>
              <input type="password" class="form-control" id="password" required>
            </div>
            <button type="submit" class="btn btn-primary">登入</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // 基本設定
    const ADMIN_USERNAME = "114";
    const ADMIN_PASSWORD = "114";
    let isAdmin = false;
    let currentWeek = 1;

    // 教師名單
    const teachers = ['李靜汝', '田慧晶', '江佳容', '林怡彣'];

    // 初始化資料
    let scheduleData = {
      ipad: Array(52).fill().map(() => Array(8).fill().map(() => Array(5).fill().map(() => ({
        teacher: '',
        status: 'available',
        permanentBlocked: false
      })))),
      chromebook: Array(52).fill().map(() => Array(8).fill().map(() => Array(5).fill().map(() => ({
        teacher: '',
        status: 'available',
        permanentBlocked: false
      })))),
      'chromebook-backup': Array(52).fill().map(() => Array(8).fill().map(() => Array(5).fill().map(() => ({
        teacher: '',
        status: 'available',
        permanentBlocked: false
      }))))
    };

    // 初始化週次選單
    function initWeekSelect() {
      const weekSelect = document.getElementById('weekSelect');
      weekSelect.innerHTML = '';
      for (let i = 1; i <= 52; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = `第${i}週`;
        weekSelect.appendChild(option);
      }
      weekSelect.value = currentWeek;
    }

    // 更新畫面
    function updateSchedule() {
      const scheduleBody = document.getElementById('scheduleBody');
      const room = document.getElementById('roomSelect').value;
      scheduleBody.innerHTML = '';

      for (let period = 1; period <= 8; period++) {
        const row = document.createElement('tr');
        row.innerHTML = `<th>${period}</th>`;
        
        for (let day = 0; day < 5; day++) {
          const cell = document.createElement('td');
          cell.className = 'schedule-cell';
          const cellData = scheduleData[room][currentWeek - 1][period - 1][day];

          if (isAdmin) {
            const select = document.createElement('select');
            select.className = 'form-select';
            select.innerHTML = `
              <option value="available">可借用</option>
              <option value="blocked">不可借用</option>
              <option value="permanent-blocked">永久不可借用</option>
              ${teachers.map(t => `<option value="${t}">${t}</option>`).join('')}
            `;

            if (cellData.permanentBlocked) {
              select.value = 'permanent-blocked';
              cell.classList.add('permanent-blocked');
            } else if (cellData.status === 'blocked') {
              select.value = 'blocked';
              cell.classList.add('not-available');
            } else if (cellData.teacher) {
              select.value = cellData.teacher;
              cell.classList.add('reserved');
            }

            select.addEventListener('change', e => {
              const value = e.target.value;
              if (value === 'permanent-blocked') {
                for (let week = 0; week < 52; week++) {
                  scheduleData[room][week][period - 1][day].permanentBlocked = true;
                  scheduleData[room][week][period - 1][day].status = 'blocked';
                  scheduleData[room][week][period - 1][day].teacher = '';
                }
                cell.classList.add('permanent-blocked');
                cell.classList.remove('not-available', 'reserved');
              } else if (value === 'blocked') {
                cellData.status = 'blocked';
                cellData.teacher = '';
                cellData.permanentBlocked = false;
                cell.classList.add('not-available');
                cell.classList.remove('permanent-blocked', 'reserved');
              } else if (value === 'available') {
                cellData.status = 'available';
                cellData.teacher = '';
                cellData.permanentBlocked = false;
                cell.classList.remove('not-available', 'permanent-blocked', 'reserved');
              } else {
                cellData.status = 'reserved';
                cellData.teacher = value;
                cellData.permanentBlocked = false;
                cell.classList.add('reserved');
                cell.classList.remove('not-available', 'permanent-blocked');
              }
              localStorage.setItem('scheduleData', JSON.stringify(scheduleData));
            });

            cell.appendChild(select);
          } else {
            if (cellData.permanentBlocked) {
              cell.textContent = '永久不可借用';
              cell.classList.add('permanent-blocked');
            } else if (cellData.status === 'blocked') {
              cell.textContent = '不可借用';
              cell.classList.add('not-available');
            } else if (cellData.teacher) {
              cell.textContent = `借用人: ${cellData.teacher}`;
              cell.classList.add('reserved');
            } else {
              cell.textContent = '可借用';
            }
          }
          
          row.appendChild(cell);
        }
        scheduleBody.appendChild(row);
      }
    }

    // 事件監聽
    document.getElementById('loginBtn').addEventListener('click', () => {
      const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
      loginModal.show();
    });

    document.getElementById('loginForm').addEventListener('submit', e => {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      
      if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
        isAdmin = true;
        bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
        updateSchedule();
      } else {
        alert('帳號或密碼錯誤！');
      }
    });

    document.getElementById('weekSelect').addEventListener('change', e => {
      currentWeek = parseInt(e.target.value);
      updateSchedule();
    });

    document.getElementById('prevWeek').addEventListener('click', () => {
      if (currentWeek > 1) {
        currentWeek--;
        document.getElementById('weekSelect').value = currentWeek;
        updateSchedule();
      }
    });

    document.getElementById('nextWeek').addEventListener('click', () => {
      if (currentWeek < 52) {
        currentWeek++;
        document.getElementById('weekSelect').value = currentWeek;
        updateSchedule();
      }
    });

    document.getElementById('roomSelect').addEventListener('change', () => {
      updateSchedule();
    });

    // 載入儲存的資料
    const savedData = localStorage.getItem('scheduleData');
    if (savedData) {
      scheduleData = JSON.parse(savedData);
    }

    // 初始化
    initWeekSelect();
    updateSchedule();
  </script>
</body>
</html>
